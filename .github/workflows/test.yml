name: push-result-to-discord
on: [push]
jobs:
  run:
    runs-on: ubuntu-latest
    outputs:
      summary: ${{ steps.summary.outputs.file }}
      result: ${{ steps.result.outputs.file }}
    defaults:
      run:
        working-directory: ./code
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-python@v2
        with:
          python-version: '3.x' # Version range or exact version of a Python version to use, using SemVer's version range syntax
          architecture: 'x64' # optional x64 or x86. Defaults to x64 if not specified
      - run: pip install --user numpy
      - run: mkdir etc
      - run: python prisonersDilemma.py
      - id: summary
        run: |
        output="$(cat summary.txt)"
        output="${output//'%'/'%25'}"
        output="${output//$'\n'/'%0A'}"
        output="${output//$'\r'/'%0D'}"
        echo "::set-output name=file::$output"
      - id: results
        run: |
        output="$(cat results.txt)"
        output="${output//'%'/'%25'}"
        output="${output//$'\n'/'%0A'}"
        output="${output//$'\r'/'%0D'}"
        echo "::set-output name=file::$output"
  publish:
    runs-on: ubuntu-latest
    needs: run
    steps:
      - uses: tsickert/discord-webhook@v2.0.2
        with:
          webhook-url: ${{ secrets.WEBHOOK_URL }}
          content: ${{ needs.run.outputs.summary }}
